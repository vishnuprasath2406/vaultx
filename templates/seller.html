<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>VaultX Seller Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>

/* ===== YOUR SAME DESIGN (UNCHANGED) ===== */
*{margin:0;padding:0;box-sizing:border-box;font-family:Segoe UI, Arial;}
body{display:flex;min-height:100vh;background:#f1f5f9;}
.sidebar{width:250px;background:linear-gradient(180deg,#1e3a8a,#2563eb);color:white;padding:25px 20px;display:flex;flex-direction:column;}
.brand{display:flex;align-items:center;gap:10px;margin-bottom:30px;}
.brand img{width:35px;height:35px;object-fit:contain;}
.brand h2{font-size:20px;}
.sidebar button{background:none;border:none;color:white;text-align:left;padding:12px;margin:5px 0;border-radius:8px;cursor:pointer;transition:.3s;font-size:15px;}
.sidebar button:hover,.sidebar button.active{background:rgba(255,255,255,.2);transform:translateX(5px);}
.main{flex:1;padding:30px;}
.section{display:none;animation:fadeIn .4s ease;}
.section.active{display:block;}
@keyframes fadeIn{from{opacity:0;transform:translateY(15px);}to{opacity:1;transform:translateY(0);}}
.card{background:white;padding:25px;border-radius:12px;box-shadow:0 10px 25px rgba(0,0,0,.08);margin-bottom:25px;}
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;}
.stat-box{background:linear-gradient(135deg,#2563eb,#1e40af);color:white;padding:25px;border-radius:12px;text-align:center;}
.stat-box h2{font-size:32px;}
input{width:100%;padding:12px;margin:8px 0;border-radius:8px;border:1px solid #cbd5e1;}
button.primary{background:#2563eb;color:white;border:none;padding:10px 15px;border-radius:8px;cursor:pointer;margin-top:10px;}
table{width:100%;border-collapse:collapse;margin-top:15px;}
th,td{padding:10px;border-bottom:1px solid #e2e8f0;}
th{background:#eff6ff;}
@media(max-width:768px){body{flex-direction:column;} .sidebar{width:100%;flex-direction:row;overflow-x:auto;} .sidebar button{flex:1;text-align:center;}}
/* Toast Message */
.toast{
position:fixed;
top:20px;
right:20px;
padding:15px 25px;
border-radius:10px;
color:white;
font-weight:600;
animation:slideIn .4s ease;
z-index:9999;
box-shadow:0 10px 25px rgba(0,0,0,.15);
}

.success-toast{
background:#16a34a;
}

.error-toast{
background:#dc2626;
}

@keyframes slideIn{
from{transform:translateX(100%);opacity:0;}
to{transform:translateX(0);opacity:1;}
}
table{
width:100%;
border-collapse:separate;
border-spacing:0;
margin-top:20px;
overflow:hidden;
border-radius:12px;
}

th{
background:#2563eb;
color:white;
font-weight:600;
}

td{
background:white;
}

tr:hover td{
background:#f1f5f9;
transition:.2s;
}
.spinner{
width:16px;
height:16px;
border:2px solid white;
border-top:2px solid transparent;
border-radius:50%;
display:inline-block;
animation:spin .6s linear infinite;
margin-left:8px;
vertical-align:middle;
}

@keyframes spin{
to{ transform:rotate(360deg); }
}
.card{
background:rgba(255,255,255,0.7);
backdrop-filter:blur(12px);
-webkit-backdrop-filter:blur(12px);
border:1px solid rgba(255,255,255,0.3);
}
body{
background:linear-gradient(135deg,#e0f2fe,#f1f5f9);
}
.analytics-container{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:25px;
  margin-top:20px;
}

.live-card{
  position:relative;
  padding:30px;
  border-radius:18px;
  color:white;
  overflow:hidden;
  box-shadow:0 20px 40px rgba(0,0,0,0.15);
  transition:0.3s ease;
}

.live-card:hover{
  transform:translateY(-6px);
}

.live-card h3{
  font-weight:500;
  opacity:0.9;
}

.live-card h1{
  font-size:48px;
  margin-top:10px;
  font-weight:700;
}

.customers{
  background:linear-gradient(135deg,#2563eb,#1e3a8a);
}

.products{
  background:linear-gradient(135deg,#16a34a,#065f46);
}

/* Glow pulse animation */
.pulse{
  position:absolute;
  width:200px;
  height:200px;
  background:rgba(255,255,255,0.1);
  border-radius:50%;
  top:-50px;
  right:-50px;
  animation:pulseAnim 3s infinite;
}

@keyframes pulseAnim{
  0%{transform:scale(1);}
  50%{transform:scale(1.3);}
  100%{transform:scale(1);}
}
.analytics-grid{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:20px;
  margin-top:20px;
}

.metric-card{
  background:white;
  padding:20px;
  border-radius:15px;
  box-shadow:0 10px 30px rgba(0,0,0,0.08);
  transition:0.3s ease;
}

.metric-card:hover{
  transform:translateY(-5px);
}

.metric-card h4{
  color:#64748b;
  font-weight:500;
}

.metric-card h1{
  font-size:36px;
  margin-top:10px;
  color:#1e293b;
}

.charts-grid{
  display:grid;
  grid-template-columns:1fr 2fr;
  gap:20px;
  margin-top:30px;
}

.chart-box{
  background:white;
  padding:20px;
  border-radius:15px;
  box-shadow:0 10px 30px rgba(0,0,0,0.08);
}
.metric-card {
    position:relative;
}

.metric-card::after{
    content:"";
    position:absolute;
    right:-40px;
    top:-40px;
    width:120px;
    height:120px;
    background:rgba(37,99,235,0.05);
    border-radius:50%;
}

</style>
</head>

<body>

<div class="sidebar">
<div class="brand">
{% load static %}

    <img src="{% static 'images/logo.png' %}" alt="VaultX Logo">
<h2>VaultX</h2>
</div>

<button onclick="showSection('dashboard',this)" class="active">Dashboard</button>
<button onclick="showSection('register',this)">Register Product</button>
<button onclick="showSection('manage',this)">Manage Products</button>
<button onclick="showSection('analytics', this)">Analytics</button>
<button onclick="logout()">Logout</button>
</div>

<div class="main">

<!-- DASHBOARD -->
<div id="dashboard" class="section active">
<div class="card">
<h2>Dashboard Overview</h2>
<div class="stats">
<div class="stat-box"><h2 id="totalCustomers">0</h2><p>Total Customers</p></div>
<div class="stat-box"><h2 id="totalProducts">0</h2><p>Products Sold</p></div>
<div class="stat-box"><h2 id="activeWarranties">0</h2><p>Active Warranties</p></div>
</div>
</div>
</div>

<!-- REGISTER PRODUCT -->
<div id="register" class="section">
<div class="card">
<h2>Add Product</h2>

<input id="customerId" type="text" pattern="[0-9]{2,10}" required placeholder="Customer ID">

<input id="customerName" type="text" pattern="[A-Za-z ]{3,30}" required placeholder="Customer Name">

<input id="customerEmail" type="email" required placeholder="Email">
<input id="customerMobile" type="tel" pattern="[0-9]{10}" required placeholder="Mobile Number">

<input id="customerAddress" type="text" minlength="10" required placeholder="Address">


<input id="customerPassword" placeholder="Customer Password">

<input id="productName" placeholder="Product Name">
<input id="serialNumber" placeholder="Serial Number">

<input id="warrantyStart" type="date">
<input id="warrantyEnd" type="date">

<button class="primary" onclick="addProduct()">Add Product</button>

</div>
</div>

<!-- MANAGE -->
<div id="manage" class="section">
<div class="card">
<h2>Manage Products</h2>
<input id="searchId" placeholder="Search Customer ID">
<button class="primary" onclick="searchCustomer()">Search</button>
<div id="results"></div>
</div>
</div>

<!-- ANALYTICS -->
<!-- ANALYTICS -->
<div id="analytics" class="section">
<div class="card">


  <h2>Analytics Dashboard</h2>

  <div class="analytics-grid">

      <div class="metric-card">
          <h4>Total Customers</h4>
          <h1 id="analyticsCustomers">0</h1>


      </div>

      <div class="metric-card">
          <h4>Total Products</h4>
          <h1 id="analyticsProducts">0</h1>

      </div>

      

       <div class="metric-card">
        <h4>Pending Claims</h4>
        <h1 id="analyticsPending">0</h1> 
      </div>
 

    </div>

  <div class="charts-grid">

      <div class="chart-box">
          <canvas id="claimsDonut"></canvas>
      </div>

      <div class="chart-box">
          <canvas id="performanceChart"></canvas>
      </div>

  </div>

</div>
</div>

<script>
  // Set today's date automatically
window.addEventListener("DOMContentLoaded", function () {

    const today = new Date().toISOString().split("T")[0];

    const startInput = document.getElementById("warrantyStart");
    const endInput = document.getElementById("warrantyEnd");

    /* ðŸ”’ WARRANTY START - ONLY TODAY */
    if (startInput) {
        startInput.value = today;
        startInput.min = today;
        startInput.max = today;

        // Block typing but allow calendar
        startInput.addEventListener("keydown", function(e){
            e.preventDefault();
        });
    }

    /* ðŸ”“ WARRANTY END - TODAY + FUTURE */
    if (endInput) {
        endInput.min = today;

        // Block typing but allow calendar
        endInput.addEventListener("keydown", function(e){
            e.preventDefault();
        });
    }

});


function animateValue(id, start, end, duration) {
    let range = end - start;
    let current = start;
    let increment = end > start ? 1 : -1;
    let stepTime = Math.abs(Math.floor(duration / range));
    let obj = document.getElementById(id);

    let timer = setInterval(function() {
        current += increment;
        obj.textContent = current;
        if (current == end) {
            clearInterval(timer);
        }
    }, stepTime);
}
let donutChart;
let lineChart;

function loadAnalytics(){

  fetch("/dashboard-stats/")
  .then(res => res.json())
  .then(data => {

    animateCounter("analyticsCustomers", data.customers);
    animateCounter("analyticsProducts", data.products);

  });

  fetch("/service-dashboard-api/")
  .then(res => res.json())
  .then(data => {

    document.getElementById("analyticsPending").innerText = data.pending || 0;

    createCharts(data);

  });

}
function animateCounter(id, endValue){
    let element = document.getElementById(id);
    let start = 0;
    let duration = 1000;
    let stepTime = 20;
    let increment = endValue / (duration/stepTime);

    let counter = setInterval(()=>{
        start += increment;
        if(start >= endValue){
            start = endValue;
            clearInterval(counter);
        }
        element.innerText = Math.floor(start);
    }, stepTime);
}





function createCharts(data){

  if (donutChart) donutChart.destroy();
  if (lineChart) lineChart.destroy();

  donutChart = new Chart(document.getElementById("claimsDonut"), {
    type: 'doughnut',
    data: {
      labels: ['Pending', 'Approved', 'In Repair', 'Completed'],
      datasets: [{
        data: [
          data.pending || 0,
          data.approved || 0,
          data.repair || 0,
          data.completed_today || 0
        ],
        backgroundColor: [
          '#f59e0b',
          '#2563eb',
          '#7c3aed',
          '#16a34a'
        ]
      }]
    },
    options:{ responsive:true }
  });

  lineChart = new Chart(document.getElementById("performanceChart"), {
    type: 'line',
    data: {
      labels: ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'],
      datasets: [{
        label: 'Claims Activity',
        data: [3,5,2,6,4,7,5],
        borderColor:'#2563eb',
        backgroundColor:'rgba(37,99,235,0.1)',
        fill:true,
        tension:0.4
      }]
    },
    options:{ responsive:true }
  });

}


setInterval(loadAnalytics, 8000);



window.onload = loadAnalytics;

/* SECTION SWITCH */
function showSection(id,btn){
document.querySelectorAll(".section").forEach(sec=>sec.classList.remove("active"));
document.getElementById(id).classList.add("active");
document.querySelectorAll(".sidebar button").forEach(b=>b.classList.remove("active"));
btn.classList.add("active");
}

/* CSRF */
function getCookie(name){
let cookieValue=null;
if(document.cookie){
let cookies=document.cookie.split(";");
for(let i=0;i<cookies.length;i++){
let cookie=cookies[i].trim();
if(cookie.startsWith(name+"=")){
cookieValue=decodeURIComponent(cookie.substring(name.length+1));
break;
}
}
}
return cookieValue;
}

/* ADD PRODUCT */
function addProduct(){
const inputs = document.querySelectorAll("#register input");

for (let input of inputs) {
    if (!input.checkValidity()) {
        input.reportValidity();
        return;
    }
}

let btn = document.querySelector("#register .primary");
btn.disabled = true;
btn.innerHTML = "Saving <span class='spinner'></span>";


let payload={
customer_id:customerId.value,
name:customerName.value,
email:customerEmail.value,
mobile:customerMobile.value,
address:customerAddress.value,
password:customerPassword.value,
product_name:productName.value,
serial_number:serialNumber.value,
warranty_start:warrantyStart.value,
warranty_end:warrantyEnd.value
};

fetch("/add-product/",{
method:"POST",
headers:{
"Content-Type":"application/json",
"X-CSRFToken":getCookie("csrftoken")
},
body:JSON.stringify(payload)
})
.then(res=>res.json())
.then(data=>{


showSuccess("Product Added Successfully ðŸŽ‰");


document.querySelectorAll("#register input").forEach(i=>i.value="");


updateDashboard();


setTimeout(()=>{
showSection("dashboard", document.querySelectorAll(".sidebar button")[0]);
},1000);

})
.catch(()=>{
showError("Error Saving Data âŒ");
})
.finally(()=>{
btn.disabled = false;
btn.innerHTML = "Add Product";

});

}



function searchCustomer(){

let sid=searchId.value;

fetch("/search-customer/"+sid+"/")
.then(res=>res.json())
.then(data=>{

if(data.error){
results.innerHTML="No Results Found";
return;
}

let html="<table><tr><th>Name</th><th>Email</th><th>Mobile</th><th>Product</th><th>Serial</th></tr>";

data.products.forEach(p=>{
html+=`<tr>
<td>${data.name}</td>
<td>${data.email}</td>
<td>${data.mobile}</td>
<td>${p.product_name}</td>
<td>${p.serial_number}</td>
</tr>`;
});

html+="</table>";
results.innerHTML=html;

});
}

/* DASHBOARD STATS */
function animateCounter(id, endValue){
let element = document.getElementById(id);
let start = 0;
let duration = 1000;
let stepTime = 20;
let increment = endValue / (duration/stepTime);

let counter = setInterval(()=>{
start += increment;
if(start >= endValue){
start = endValue;
clearInterval(counter);
}
element.innerText = Math.floor(start);
}, stepTime);
}

function updateDashboard(){
fetch("/dashboard-stats/")
.then(res=>res.json())
.then(data=>{
animateCounter("totalCustomers", data.customers);
animateCounter("totalProducts", data.products);
animateCounter("activeWarranties", data.products);
});
}


function loadChart(customers,products){
new Chart(document.getElementById("salesChart"),{
type:"bar",
data:{
labels:["Customers","Products"],
datasets:[{
label:"VaultX Sales",
data:[customers,products]
}]
}
});
}

updateDashboard();

/* LOGOUT */
function logout(){
window.location.href="/logout/";
}
function showSuccess(message){
let box = document.createElement("div");
box.className="toast success-toast";
box.innerText=message;
document.body.appendChild(box);

setTimeout(()=>{ box.remove(); },3000);
}

function showError(message){
let box = document.createElement("div");
box.className="toast error-toast";
box.innerText=message;
document.body.appendChild(box);

setTimeout(()=>{ box.remove(); },3000);
}
function loadSalesChart(){

fetch("/dashboard-stats/")
.then(res=>res.json())
.then(data=>{

const ctx = document.getElementById('salesChart').getContext('2d');

new Chart(ctx,{
type:'bar',
data:{
labels:['Customers','Products'],
datasets:[{
label:'VaultX Data',
data:[data.customers, data.products],
backgroundColor:[
'#2563eb',
'#16a34a'
],
borderRadius:8
}]
},
options:{
responsive:true,
plugins:{
legend:{display:false}
}
}
});

});

}

/* Load chart when analytics opened */
document.querySelectorAll(".sidebar button")[3]
.addEventListener("click", loadSalesChart);

</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- ================= VAULTX CHATBOT ================= -->
<div id="vx-chat-button">ðŸ’¬</div>

<div id="vx-chat">

    <div class="vx-header">
        <div class="vx-title">
            <div class="vx-avatar">V</div>
            <div>
                <b>VaultX Assistant</b>
                <small>Online</small>
            </div>
        </div>
        <div id="vx-close">âœ•</div>
    </div>

    <div id="vx-messages"></div>

    <div class="vx-input">
        <input id="vx-text" placeholder="Ask about warranty, claims, repairs..." autocomplete="off">
        <button id="vx-send">âž¤</button>
    </div>

</div>

<style>

/* Floating button */
#vx-chat-button{
    position:fixed;
    bottom:22px;
    right:22px;
    width:64px;
    height:64px;
    border-radius:50%;
    background:linear-gradient(135deg,#2563eb,#1e3a8a);
    display:flex;
    align-items:center;
    justify-content:center;
    color:white;
    font-size:28px;
    cursor:pointer;
    box-shadow:0 12px 30px rgba(0,0,0,.25);
    z-index:9999;
}

/* Chat box */
#vx-chat{
    position:fixed;
    bottom:100px;
    right:22px;
    width:360px;
    height:520px;
    background:#fff;
    border-radius:20px;
    box-shadow:0 25px 70px rgba(0,0,0,.28);
    display:flex;
    flex-direction:column;
    overflow:hidden;
    transform:translateY(40px) scale(.9);
    opacity:0;
    pointer-events:none;
    transition:.25s ease;
    z-index:9999;
}
#vx-chat.open{
    transform:translateY(0) scale(1);
    opacity:1;
    pointer-events:auto;
}

/* Header */
.vx-header{
    background:linear-gradient(135deg,#2563eb,#1e40af);
    color:white;
    padding:14px;
    display:flex;
    justify-content:space-between;
    align-items:center;
}
.vx-title{display:flex;gap:10px;align-items:center;}
.vx-avatar{
    width:36px;height:36px;border-radius:50%;
    background:white;color:#2563eb;
    display:flex;align-items:center;justify-content:center;
    font-weight:bold;
}
#vx-close{cursor:pointer;font-size:18px}

/* Messages */
#vx-messages{
    flex:1;
    padding:16px;
    overflow-y:auto;
    background:#f1f5f9;
}

.msg{
    max-width:75%;
    padding:10px 14px;
    border-radius:16px;
    margin-bottom:10px;
    line-height:1.4;
    white-space:pre-wrap;
}
.user{background:#2563eb;color:white;margin-left:auto;border-bottom-right-radius:4px;}
.bot{background:white;border:1px solid #e5e7eb;border-bottom-left-radius:4px;}
.typing{opacity:.6;font-style:italic}

/* Input */
.vx-input{
    display:flex;
    padding:12px;
    border-top:1px solid #e5e7eb;
    background:white;
}
#vx-text{
    flex:1;
    border:none;
    outline:none;
    background:#f1f5f9;
    padding:12px;
    border-radius:30px;
}
#vx-send{
    margin-left:10px;
    border:none;
    background:#2563eb;
    color:white;
    border-radius:50%;
    width:42px;
    height:42px;
    cursor:pointer;
}

/* Mobile responsive */
@media(max-width:600px){
    #vx-chat{
        width:100%;
        height:100%;
        right:0;
        bottom:0;
        border-radius:0;
    }
}

</style>

<script>

const btn=document.getElementById("vx-chat-button");
const chat=document.getElementById("vx-chat");
const close=document.getElementById("vx-close");
const send=document.getElementById("vx-send");
const input=document.getElementById("vx-text");
const box=document.getElementById("vx-messages");

/* open / close */
btn.onclick=()=>chat.classList.toggle("open");
close.onclick=()=>chat.classList.remove("open");

/* add message */
function addMessage(text,type,extra=""){
    const div=document.createElement("div");
    div.className=`msg ${type} ${extra}`;
    div.textContent=text;
    box.appendChild(div);
    box.scrollTop=box.scrollHeight;
    return div;
}

/* send to django */
async function sendMessage(){

    const text=input.value.trim();
    if(!text) return;

    addMessage(text,"user");
    input.value="";

    const typing=addMessage("Typing...","bot","typing");

    try{
        const response=await fetch("/chatbot_api/",{
            method:"POST",
            headers:{
                "Content-Type":"application/json"
            },
            body:JSON.stringify({message:text})
        });

        const data=await response.json();
        typing.remove();

        if(data.reply)
            addMessage(data.reply,"bot");
        else
            addMessage("AI did not respond properly.","bot");

    }catch(e){
        typing.remove();
        addMessage("Server connection failed.","bot");
    }
}

/* send events */
send.onclick=sendMessage;
input.addEventListener("keypress",e=>{
    if(e.key==="Enter") sendMessage();
});

</script>
<!-- ================= END CHATBOT ================= -->

</body>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</html>
